#!/usr/bin/env ruby

require_relative '../build'
require 'yaml'

case ARGV[0]
when "build"
  puts "Building the site..."
  build_site
  puts "Build complete!"

when "serve"
  puts "Serving the site..."
  
  index_path = "site/index.html"
  if File.exist?(index_path)
    system("open #{index_path}")  # For macOS
    # For Linux, use `xdg-open`:
    # system("xdg-open #{index_path}")
    # For Windows, use `start`:
    # system("start #{index_path}")
  else
    puts "Error: 'site/index.html' not found. Please build the site first."
  end

when "clean"
  content_files = Dir.glob("content/**/*").map do |file|
    if File.extname(file) == ".md"
      metadata = File.read(file).match(/^---\n(.*?)\n---/m)[1]
      yaml_data = YAML.load(metadata)
      yaml_data['slug']
    end
  end.compact

  site_files = Dir.glob("site/*.html").map { |file| File.basename(file, File.extname(file)) }

  files_to_delete = site_files - content_files
  puts content_files
  puts "-----"
  puts site_files
  puts "-----"
  puts files_to_delete

  files_to_delete.each do |file|
    file_path = "site/#{file}.html"
    File.delete(file_path) if File.exist?(file_path)
    puts "Deleted: #{file_path}"
  end
  

when "help", nil
  # Display help information
  puts <<~HELP
    Kondo - A super-minimal static site generator

    Usage:
      kondo build    # Generate the static site
      kondo serve    # Open the site locally in your default browser
      kondo help     # Show this help message
  HELP

else
  puts "Unknown command: #{ARGV[0]}"
  puts "Run 'kondo help' for usage."
end
